<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Large File Uploading</title>
    <!-- <link rel="stylesheet" href="./css/style.css"> -->
</head>
<body>
    <form action="" enctype="multipart/form-data" onsubmit="dontRefresh()">
        <label for="file">Upload a File</label>
        <input type="file" name="file" id="file" onchange="fileClick()">
        <button id="upload" onclick="upload()">Upload</button>
    </form>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
    const chunkSize = 2*1024*1024;
    const reader = new FileReader();
    let totalChunks = 0
    let chunkCount = 0;
    let fileSize = 0;
    let sizeRemaining = 0;
    let offset = 0
    let theFile = null;

    let noOfChunks = 0
    if(fileSize < 10*1024*1024)
        noOfChunks = 1
    else if(fileSize < 100*1024*1024)
        noOfChunks = 2
    else if(fileSize < 1000*1024*1024)
        noOfChunks = 4
    else noOfChunks = 6

    let chunks = []
    let writePromises = []

      function fileClick(){
        const file = document.getElementById("file").files[0];
        if(file.size > chunkSize){
          fileSize = file.size;
          theFile = file
          sizeRemaining = fileSize
          totalChunks = Math.ceil(fileSize/chunkSize);
        
            let chunk = new Blob();


      //       console.log(file);

            readNextChunk()

            // reader.addEventListener('load', function(evt){
            //   console.log(evt);
            // })

      //   }
        }
        
      }

    //   // function upload(){
    //   //   readFile
    //   // }

      async function readNextChunk(){
        console.log("hi");
        writePromises = []
        if(sizeRemaining == 0 && chunks.length > 0){
          for (const chunk of chunks){
                    writePromises.push( sendChunkToServer(chunk, totalChunks, noOfChunks) )
                }
                chunks = []
                Promise.all(writePromises);
          return;
        }
        if(sizeRemaining > 0){
          if(sizeRemaining < chunkSize){
            chunk = (document.getElementById("file").files[0]).slice(fileSize-sizeRemaining, fileSize)
            sizeRemaining = 0;
          } else {
            chunk = (document.getElementById("file").files[0]).slice((fileSize-sizeRemaining), (fileSize-sizeRemaining)+chunkSize);
            sizeRemaining = (sizeRemaining-chunkSize);
          }
          if(chunks.length == noOfChunks){
            for (const chunk of chunks){
                    writePromises.push( sendChunkToServer(chunk, totalChunks, noOfChunks) )
                }
                chunks = []
                Promise.all(writePromises);
          }
          chunks.push(chunk);
          chunkCount++;
          if(chunks.length == 0) return;
          readNextChunk();
        } else {
          return;
        }

      }

      async function sendChunkToServer(chunk, totalChunks, noOfChunks){
        return new Promise(async (resolve, reject) => {
            const res = await axios.post('http://localhost:3000/upload', chunk, {headers: {"Content-Type": "application/json", 'X-Total-Chunks': totalChunks,'X-No-Of-Chunks': noOfChunks }
            }) 
            if(res.status === 200){
                resolve("Successfull transfer.")
            }  
            else
                reject("Request failed")
      })
    }

    </script>
</body>
</html>